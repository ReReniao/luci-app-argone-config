name: Compile LuCI App (Argone Config - ARMv8)

on:
  push:
    branches: [ main ]
    paths:
      - '**'
  workflow_dispatch:

jobs:
  compile-armv8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Plugin Source
        uses: actions/checkout@v4
        with:
          path: luci-app-argone-config

      # 关键：修复工具链下载链接（使用 23.05.10 最新稳定版）
      - name: Download ARMv8 OpenWrt Toolchain (23.05.10)
        run: |
          # 最新版 ARMv8 预编译工具链（官方稳定链接，不会 404）
          wget https://downloads.openwrt.org/releases/23.05.10/targets/armvirt/64/openwrt-toolchain-23.05.10-armvirt-64_gcc-12.3.0_musl.tar.xz
          # 解压工具链
          tar xJf openwrt-toolchain-23.05.10-armvirt-64_gcc-12.3.0_musl.tar.xz
          mv openwrt-toolchain-23.05.10-armvirt-64_gcc-12.3.0_musl toolchain-armv8

      # 安装插件编译依赖
      - name: Install Plugin Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib libssl-dev python3 rsync unzip zlib1g-dev file wget

      # 配置编译环境+验证工具链
      - name: Configure & Verify Toolchain
        run: |
          cd luci-app-argone-config
          # 设置工具链环境变量
          export STAGING_DIR=$(pwd)/../toolchain-armv8/staging_dir
          export PATH=$(pwd)/../toolchain-armv8/bin:$PATH
          # 验证 ARMv8 编译器（输出 aarch64 版本说明成功）
          aarch64-openwrt-linux-musl-gcc --version

      # 编译插件（无架构冲突，直接生成 ARMv8 .ipk）
      - name: Compile Plugin (ARMv8 Final)
        run: |
          cd luci-app-argone-config
          export STAGING_DIR=$(pwd)/../toolchain-armv8/staging_dir
          export PATH=$(pwd)/../toolchain-armv8/bin:$PATH
          # 编译插件（调用自带 Makefile）
          make V=s -j1
          # 查看产物（日志中确认 .ipk 生成）
          ls -la bin/

      # 上传最终产物
      - name: Upload ARMv8 IPK
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argone-config-armv8-ipk
          path: luci-app-argone-config/bin/luci-app-argone-config_*.ipk
          retention-days: 30
