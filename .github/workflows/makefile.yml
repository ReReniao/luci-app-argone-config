name: Compile LuCI App (Argone Config - ARMv8)
on:
  push:
    branches: [main]
    paths: ['**']
  workflow_dispatch:

jobs:
  compile-armv8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Plugin Source
        uses: actions/checkout@v4
        with:
          path: luci-app-argone-config

      - name: Checkout OpenWrt Source (23.05)
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: openwrt-23.05
          path: openwrt
          fetch-depth: 0  # 拉取完整源码，避免配置文件缺失
          submodules: true

      - name: Install Full Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++-9 gcc-9 gawk gcc-multilib gettext \
            git libncurses5-dev libncursesw5-dev libssl-dev python3 rsync unzip zlib1g-dev file wget libdeflate-dev \
            python3-distutils python3-setuptools
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 50
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 50

      - name: Add 6G Swap Space (Critical for Toolchain)
        run: |
          sudo fallocate -l 6G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          swapon --show

      - name: Patch OpenWrt to Force ARMv8 (Bypass Default Arch)
        run: |
          cd openwrt
          # 补丁：修改 target 检测逻辑，强制默认架构为 armvirt-64
          echo -e '#!/bin/bash\necho "armvirt"\necho "64"' > scripts/get_default_target.sh
          chmod +x scripts/get_default_target.sh
          # 更新 feeds 并安装依赖
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp -r ../luci-app-argone-config package/luci-app-argone-config

      - name: Lock ARMv8 Config & Build
        run: |
          cd openwrt
          # 彻底清空旧配置
          rm -rf .config .config.old staging_dir/ build_dir/ bin/
          # 写入强制 ARMv8 配置
          cat > .config << EOF
          CONFIG_TARGET=armvirt
          CONFIG_TARGET_armvirt=y
          CONFIG_TARGET_armvirt_64=y
          CONFIG_TARGET_armvirt_64_Default=y
          CONFIG_PACKAGE_luci-app-argone-config=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_DEVEL=y
          CONFIG_OPTIMIZE_FOR_SIZE=y
          CONFIG_DEBUG=n
          EOF
          # 生成配置并编译
          make defconfig
          make package/luci-app-argone-config/compile V=s -j1

      - name: Locate & Upload IPK
        run: |
          cd openwrt
          # 全局查找生成的 ipk 文件
          find . -name "luci-app-argone-config_*.ipk" -exec cp {} ../ \;
        working-directory: .

      - name: Upload Final IPK
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argone-config-armv8-ipk
          path: luci-app-argone-config_*.ipk
          retention-days: 30
