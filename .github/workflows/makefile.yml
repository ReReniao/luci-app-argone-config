name: Compile LuCI App (Argone Config - ARMv8)

on:
  push:
    branches: [ main ]
    paths:
      - '**'
  workflow_dispatch:

jobs:
  compile-armv8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Plugin Source
        uses: actions/checkout@v4
        with:
          path: luci-app-argone-config

      # 关键：使用 ARMv8 预编译工具链（避免架构配置冲突）
      - name: Download ARMv8 OpenWrt Toolchain (23.05)
        run: |
          # 下载 OpenWrt 23.05 官方 ARMv8 预编译工具链
          wget https://downloads.openwrt.org/releases/23.05.0/targets/armvirt/64/openwrt-toolchain-23.05.0-armvirt-64_gcc-12.3.0_musl.tar.xz
          # 解压工具链到指定目录
          tar xJf openwrt-toolchain-23.05.0-armvirt-64_gcc-12.3.0_musl.tar.xz
          mv openwrt-toolchain-23.05.0-armvirt-64_gcc-12.3.0_musl toolchain-armv8

      # 安装插件编译依赖（无需完整 OpenWrt 源码）
      - name: Install Plugin Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib libssl-dev python3 rsync unzip zlib1g-dev file wget

      # 配置插件编译环境（直接用预编译工具链）
      - name: Configure Plugin Compile Env
        run: |
          # 进入插件目录
          cd luci-app-argone-config
          # 设置工具链路径
          export STAGING_DIR=$(pwd)/../toolchain-armv8/staging_dir
          export PATH=$(pwd)/../toolchain-armv8/bin:$PATH
          # 验证工具链（确认是 ARMv8 版本）
          aarch64-openwrt-linux-musl-gcc --version

      # 编译插件（直接调用插件 Makefile，无架构冲突）
      - name: Compile Plugin with ARMv8 Toolchain
        run: |
          cd luci-app-argone-config
          export STAGING_DIR=$(pwd)/../toolchain-armv8/staging_dir
          export PATH=$(pwd)/../toolchain-armv8/bin:$PATH
          # 调用插件自带 Makefile 编译
          make V=s -j1
          # 查看生成的 .ipk 文件
          ls -la bin/  # 确认 .ipk 生成

      # 上传最终 ARMv8 产物
      - name: Upload ARMv8 IPK
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argone-config-armv8-ipk
          path: luci-app-argone-config/bin/luci-app-argone-config_*.ipk
          retention-days: 30
