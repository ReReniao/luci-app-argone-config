name: Compile LuCI App (Argone Config - ARMv8)
on:
  push:
    branches: [main]
    paths: ['**']
  workflow_dispatch:

jobs:
  compile-armv8:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Plugin Source
        uses: actions/checkout@v4
        with:
          path: luci-app-argone-config

      - name: Checkout OpenWrt Source (23.05)
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: openwrt-23.05
          path: openwrt
          fetch-depth: 0
          submodules: true

      - name: Install Full Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++-9 gcc-9 gawk gcc-multilib gettext \
            git libncurses5-dev libncursesw5-dev libssl-dev python3 rsync unzip zlib1g-dev file wget libdeflate-dev \
            python3-setuptools
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 50
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 50

      - name: Add 6G Swap Space
        run: |
          sudo fallocate -l 6G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          swapon --show

      - name: Force ARMv8 Config (No Defconfig)
        run: |
          cd openwrt
          # 1. 彻底删除默认 MIPS 架构配置文件（关键！）
          rm -rf target/linux/ath79/generic/config-default
          # 2. 复制 ARMv8 官方配置文件作为基础（无任何 MIPS 干扰）
          cp target/linux/armvirt/64/config-5.15 .config
          # 3. 勾选插件和依赖
          echo "CONFIG_PACKAGE_luci-app-argone-config=y" >> .config
          echo "CONFIG_PACKAGE_luci-compat=y" >> .config
          # 4. 编译优化配置
          echo "CONFIG_DEBUG=n" >> .config
          echo "CONFIG_OPTIMIZE_FOR_SIZE=y" >> .config
          # 5. 直接生成依赖配置，跳过 defconfig（避免覆盖）
          make oldconfig
          # 6. 验证架构配置（日志中确认是 armvirt-64）
          grep "CONFIG_TARGET" .config

      - name: Build ARMv8 Toolchain & Plugin
        run: |
          cd openwrt
          # 先编译工具链，再编译插件
          make toolchain/compile V=s -j1
          make package/luci-app-argone-config/compile V=s -j1

      - name: Locate & Copy IPK
        run: |
          cd openwrt
          # 全局查找 ARMv8 架构的 .ipk
          find bin/packages/armvirt-64/ -name "luci-app-argone-config_*.ipk" -exec cp {} ../ \;
          ls -la ../  # 确认 .ipk 已复制

      - name: Upload Final ARMv8 IPK
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argone-config-armv8-ipk
          path: luci-app-argone-config_*.ipk
          retention-days: 30
