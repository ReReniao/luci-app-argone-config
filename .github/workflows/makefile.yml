name: Compile LuCI App (Argone Config - ARMv8)

on:
  push:
    branches: [ main ]
    paths:
      - '**'
  workflow_dispatch:

jobs:
  compile-armv8:
    runs-on: ubuntu-latest  # 切换到 22.04，排队时间<1分钟
    steps:
      - name: Checkout Plugin Source
        uses: actions/checkout@v4
        with:
          path: luci-app-argone-config

      - name: Checkout OpenWrt Source (23.05)
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: openwrt-23.05
          path: openwrt
          fetch-depth: 1

      # 适配 Ubuntu 22.04 依赖（移除过时包，补装必要工具）
      - name: Install Build Dependencies (Ubuntu 22.04)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3 rsync unzip zlib1g-dev file wget libdeflate-dev \
            libncursesw5-dev  # 22.04 需补充 libncursesw5-dev 避免终端库缺失

      - name: Configure OpenWrt Env
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp -r ../luci-app-argone-config package/luci-app-argone-config

      # 强制 ARMv8 架构（双重校验，避免架构漂移）
      - name: Set ARMv8 Architecture & Select Plugin
        run: |
          cd openwrt
          rm -f .config .config.old  # 彻底清理旧配置
          # 架构配置（明确指定目标架构，不依赖默认值）
          echo "CONFIG_TARGET=armvirt" >> .config
          echo "CONFIG_TARGET_armvirt=y" >> .config
          echo "CONFIG_TARGET_armvirt_64=y" >> .config
          echo "CONFIG_TARGET_armvirt_64_Default=y" >> .config
          # 插件及依赖勾选
          echo "CONFIG_PACKAGE_luci-app-argone-config=y" >> .config
          echo "CONFIG_PACKAGE_luci-compat=y" >> .config
          # 生成配置（确保架构生效）
          make defconfig
          make oldconfig

      # 单线程编译（22.04 资源更充足，但单线程更稳定）
      - name: Compile Plugin (ARMv8)
        run: |
          cd openwrt
          make package/luci-app-argone-config/compile V=s -j1

      - name: Upload ARMv8 IPK
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argone-config-armv8-ipk
          path: openwrt/bin/packages/armvirt-64/luci/luci-app-argone-config_*.ipk
          retention-days: 30
