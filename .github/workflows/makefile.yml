name: Compile LuCI App (Argone Config - ARMv8)

on:
  push:
    branches: [ main ]
    paths:
      - '**'
  workflow_dispatch:

jobs:
  compile-armv8:
    runs-on: ubuntu-latest
    env:
      # 增加编译缓存，加速工具链构建（避免重复编译）
      OPENWRT_BUILD_DIR: /home/runner/work/luci-app-argone-config/luci-app-argone-config/openwrt
    steps:
      - name: Checkout Plugin Source
        uses: actions/checkout@v4
        with:
          path: luci-app-argone-config

      - name: Checkout OpenWrt Source (23.05)
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: openwrt-23.05
          path: openwrt
          fetch-depth: 1

      # 1. 适配工具链编译：安装低版本 GCC（兼容 OpenWrt 23.05 工具链）
      - name: Install Compatible Dependencies & GCC-9
        run: |
          sudo apt-get update
          # 安装必要依赖+GCC-9（工具链编译兼容版本）
          sudo apt-get install -y build-essential clang flex bison g++-9 gcc-9 gawk gcc-multilib gettext \
            git libncurses5-dev libncursesw5-dev libssl-dev python3 rsync unzip zlib1g-dev file wget libdeflate-dev
          # 切换默认 GCC/G++ 为 9 版本（避免高版本兼容问题）
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 50
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 50
          # 验证版本（确保 GCC 是 9.x）
          gcc --version
          g++ --version

      - name: Configure OpenWrt Env
        run: |
          cd $OPENWRT_BUILD_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp -r ../luci-app-argone-config package/luci-app-argone-config

      # 2. 优化工具链配置：关闭不必要的编译选项（减少资源占用）
      - name: Set ARMv8 Architecture & Optimize Config
        run: |
          cd $OPENWRT_BUILD_DIR
          rm -f .config .config.old
          # 架构配置
          echo "CONFIG_TARGET=armvirt" >> .config
          echo "CONFIG_TARGET_armvirt=y" >> .config
          echo "CONFIG_TARGET_armvirt_64=y" >> .config
          echo "CONFIG_TARGET_armvirt_64_Default=y" >> .config
          # 插件及依赖
          echo "CONFIG_PACKAGE_luci-app-argone-config=y" >> .config
          echo "CONFIG_PACKAGE_luci-compat=y" >> .config
          # 工具链优化：关闭调试、减少不必要功能
          echo "CONFIG_DEBUG=n" >> .config
          echo "CONFIG_OPTIMIZE_FOR_SIZE=y" >> .config
          echo "CONFIG_EXTRA_CFLAGS=-Os" >> .config
          # 生成配置
          make defconfig
          make oldconfig

      # 3. 优化编译参数：单线程+增加交换分区（解决 CI 内存不足）
      - name: Add Swap Space (Fix Memory Shortage)
        run: |
          # CI 默认内存 2G，工具链编译需 3G+，新增 2G 交换分区
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          swapon --show  # 验证交换分区生效

      - name: Compile Plugin (ARMv8 - Toolchain Compatible)
        run: |
          cd $OPENWRT_BUILD_DIR
          # 单线程编译，优先保证工具链构建成功
          make package/luci-app-argone-config/compile V=s -j1

      - name: Upload ARMv8 IPK
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-argone-config-armv8-ipk
          path: $OPENWRT_BUILD_DIR/bin/packages/armvirt-64/luci/luci-app-argone-config_*.ipk
          retention-days: 30
